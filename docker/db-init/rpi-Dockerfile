FROM ubuntu:xenial as builder
LABEL maintainer="sahil@ole.org,mappuji@ole.org"

COPY docker/db-init/crosscompile_db-init.sh .
RUN bash ./crosscompile_db-init.sh armv7 install

#####

#FROM hypriot/rpi-node:6.10.0-alpine
#FROM treehouses/node@sha256:bc4402520a64e5046f07bffe7e7330e3147dfe2d28995c73119e43ede71558ae
FROM treehouses/node-tags:arm

RUN apk update ;\
    apk add --no-cache bash curl git jq ca-certificates;\
    mkdir -p /usr/local/lib/node_modules; \
    ln -s /usr/local/lib/node_modules/add-cors-to-couchdb/bin.js /usr/local/bin/add-cors-to-couchdb

COPY --from=builder /usr/lib/node_modules /usr/local/lib/node_modules

WORKDIR /root

COPY ./docker/db-init/docker-entrypoint.sh /root/docker-entrypoint.sh
COPY ./couchdb-setup.sh /root/couchdb-setup.sh
ADD ./design /root/design

CMD bash ./docker-entrypoint.sh
